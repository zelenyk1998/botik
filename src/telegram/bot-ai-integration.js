// –î–æ–¥–∞–π—Ç–µ —Ü–µ–π –∫–æ–¥ –¥–æ bot.js, —ñ–Ω—Ç–µ–≥—Ä—É—é—á–∏ –π–æ–≥–æ –∑ –æ—Å–Ω–æ–≤–Ω–æ—é –ª–æ–≥—ñ–∫–æ—é

// –Ü–º–ø–æ—Ä—Ç –∫–ª–∞—Å—É AIAssistant
const AIAssistant = require('./aiAssistant');

// –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –µ–∫–∑–µ–º–ø–ª—è—Ä–∞ AIAssistant
const aiAssistant = new AIAssistant();

// –î–æ–¥–∞–π—Ç–µ —Ü–µ–π –∫–æ–¥ –¥–æ —Ñ—É–Ω–∫—Ü—ñ—ó startBot —É —Ñ–∞–π–ª—ñ bot.js
function addAIAssistantHandlers(bot) {
  // –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ, —è–∫—ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å –®–Ü —Ä–µ–∂–∏–º
  const aiChatModes = {};
  
  // –û–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è AI –∞—Å–∏—Å—Ç–µ–Ω—Ç–∞
  bot.onText(/\/ai/, async (msg) => {
    const chatId = msg.chat.id;
    
    // –ê–∫—Ç–∏–≤—É—î–º–æ —Ä–µ–∂–∏–º –®–Ü –¥–ª—è —Ü—å–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
    aiChatModes[chatId] = true;
    
    await bot.sendMessage(
      chatId,
      `ü§ñ *–†–µ–∂–∏–º AI –∞—Å–∏—Å—Ç–µ–Ω—Ç–∞ –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ!*\n\n–¢–µ–ø–µ—Ä –≤–∏ –º–æ–∂–µ—Ç–µ –∑–∞–¥–∞–≤–∞—Ç–∏ –º–µ–Ω—ñ –±—É–¥—å-—è–∫—ñ –ø–∏—Ç–∞–Ω–Ω—è –ø—Ä–æ –ø–∞–ª—å–Ω–µ, –ê–ó–°, –∞–≤—Ç–æ–º–æ–±—ñ–ª—ñ —Ç–∞ —ó—Ö –æ–±—Å–ª—É–≥–æ–≤—É–≤–∞–Ω–Ω—è.\n\n–©–æ–± –≤–∏–π—Ç–∏ –∑ —Ä–µ–∂–∏–º—É AI –∞—Å–∏—Å—Ç–µ–Ω—Ç–∞, –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É "–í–∏–º–∫–Ω—É—Ç–∏ AI –∞—Å–∏—Å—Ç–µ–Ω—Ç–∞" –∞–±–æ –≤–≤–µ–¥—ñ—Ç—å /exit.`,
      {
        parse_mode: 'Markdown',
        reply_markup: {
          keyboard: [
            ['‚ùå –í–∏–º–∫–Ω—É—Ç–∏ AI –∞—Å–∏—Å—Ç–µ–Ω—Ç–∞'],
            ['üìù –ü—Ä–∏–∫–ª–∞–¥–∏ –ø–∏—Ç–∞–Ω—å'],
            ['üîô –ù–∞–∑–∞–¥ –¥–æ –º–µ–Ω—é']
          ],
          resize_keyboard: true
        }
      }
    );
  });
  
  // –û–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è –≤–∏—Ö–æ–¥—É –∑ —Ä–µ–∂–∏–º—É –®–Ü
  bot.onText(/‚ùå –í–∏–º–∫–Ω—É—Ç–∏ AI –∞—Å–∏—Å—Ç–µ–Ω—Ç–∞|\/exit/, async (msg) => {
    const chatId = msg.chat.id;
    
    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤ —Ä–µ–∂–∏–º—ñ –®–Ü
    if (!aiChatModes[chatId]) {
      return;
    }
    
    // –î–µ–∞–∫—Ç–∏–≤—É—î–º–æ —Ä–µ–∂–∏–º –®–Ü
    delete aiChatModes[chatId];
    
    await bot.sendMessage(
      chatId,
      'üîô –†–µ–∂–∏–º AI –∞—Å–∏—Å—Ç–µ–Ω—Ç–∞ –≤–∏–º–∫–Ω–µ–Ω–æ. –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ—Å—å –¥–æ –∑–≤–∏—á–∞–π–Ω–æ–≥–æ —Ä–µ–∂–∏–º—É.',
      {
        reply_markup: {
          keyboard: [
            ['üîç –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ —Ü—ñ–Ω', 'üõí –ü—Ä–∏–¥–±–∞—Ç–∏ —Ç–∞–ª–æ–Ω–∏'],
              ['üé´ –ú–æ—ó —Ç–∞–ª–æ–Ω–∏', 'ü§ñ AI –∞—Å–∏—Å—Ç–µ–Ω—Ç'],
              ['üìû –ü—ñ–¥—Ç—Ä–∏–º–∫–∞', 'üë§ –ú—ñ–π –ø—Ä–æ—Ñ—ñ–ª—å'],
              ['üìç –ó–Ω–∞–π—Ç–∏ –ê–ó–°'],
              ['ü§ù –°—Ç–∞—Ç–∏ –ø–∞—Ä—Ç–Ω–µ—Ä–æ–º']
          ],
          resize_keyboard: true
        }
      }
    );
  });
  
  // –û–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è –ø—Ä–∏–∫–ª–∞–¥—ñ–≤ –ø–∏—Ç–∞–Ω—å
  bot.onText(/üìù –ü—Ä–∏–∫–ª–∞–¥–∏ –ø–∏—Ç–∞–Ω—å/, async (msg) => {
    const chatId = msg.chat.id;
    
    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤ —Ä–µ–∂–∏–º—ñ –®–Ü
    if (!aiChatModes[chatId]) {
      return;
    }
    
    await bot.sendMessage(
      chatId,
      `*–ü—Ä–∏–∫–ª–∞–¥–∏ –ø–∏—Ç–∞–Ω—å –¥–ª—è AI –∞—Å–∏—Å—Ç–µ–Ω—Ç–∞:*\n\n` +
      `- –Ø–∫–µ –ø–∞–ª—å–Ω–µ –∫—Ä–∞—â–µ –¥–ª—è –∑–∏–º–æ–≤–æ–≥–æ –ø–µ—Ä—ñ–æ–¥—É?\n` +
      `- –©–æ –æ–∑–Ω–∞—á–∞—î –æ–∫—Ç–∞–Ω–æ–≤–µ —á–∏—Å–ª–æ –±–µ–Ω–∑–∏–Ω—É?\n` +
      `- –ß–∏ –º–æ–∂–Ω–∞ –∑–º—ñ—à—É–≤–∞—Ç–∏ —Ä—ñ–∑–Ω—ñ —Ç–∏–ø–∏ –ø–∞–ª—å–Ω–æ–≥–æ?\n` +
      `- –Ø–∫ —á–∞—Å—Ç–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ –º—ñ–Ω—è—Ç–∏ –º–∞—Å–ª–æ –≤ –∞–≤—Ç–æ–º–æ–±—ñ–ª—ñ?\n` +
      `- –Ø–∫—ñ –ø–µ—Ä–µ–≤–∞–≥–∏ –ø—Ä–µ–º—ñ–∞–ª—å–Ω–æ–≥–æ –ø–∞–ª—å–Ω–æ–≥–æ?\n` +
      `- –©–æ —Ä–æ–±–∏—Ç–∏, —è–∫—â–æ –∑–∞–ª–∏–ª–∏ –Ω–µ —Ç–µ –ø–∞–ª—å–Ω–µ?\n` +
      `- –Ø–∫ –µ–∫–æ–Ω–æ–º–∏—Ç–∏ –ø–∞–ª—å–Ω–µ –ø—ñ–¥ —á–∞—Å –ø–æ—ó–∑–¥–æ–∫?\n\n` +
      `–°–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–¥–∞—Ç–∏ –æ–¥–Ω–µ –∑ —Ü–∏—Ö –ø–∏—Ç–∞–Ω—å –∞–±–æ –±—É–¥—å-—è–∫–µ —ñ–Ω—à–µ –ø–∏—Ç–∞–Ω–Ω—è –ø—Ä–æ –ø–∞–ª—å–Ω–µ, –∞–≤—Ç–æ —á–∏ –ê–ó–°.`,
      {
        parse_mode: 'Markdown'
      }
    );
  });
  
  // –î–æ–¥–∞—î–º–æ –∫–Ω–æ–ø–∫—É AI –∞—Å–∏—Å—Ç–µ–Ω—Ç–∞ –¥–æ –≥–æ–ª–æ–≤–Ω–æ–≥–æ –º–µ–Ω—é
  const originalBackToMenuHandler = bot._textRegexpCallbacks.find(
    handler => handler.regexp && handler.regexp.toString().includes('–ù–∞–∑–∞–¥ –¥–æ –º–µ–Ω—é')
  );
  
  if (originalBackToMenuHandler) {
    // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–π –æ–±—Ä–æ–±–Ω–∏–∫
    const originalCallback = originalBackToMenuHandler.callback;
    
    // –ó–∞–º—ñ–Ω—é—î–º–æ –Ω–∞ –Ω–æ–≤–∏–π –æ–±—Ä–æ–±–Ω–∏–∫, —è–∫–∏–π –¥–æ–¥–∞—î –∫–Ω–æ–ø–∫—É AI –∞—Å–∏—Å—Ç–µ–Ω—Ç–∞
    originalBackToMenuHandler.callback = async (msg, match) => {
      const chatId = msg.chat.id;
      
      // –Ø–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –±—É–≤ —É —Ä–µ–∂–∏–º—ñ –®–Ü, –≤–∏–º–∏–∫–∞—î–º–æ –π–æ–≥–æ
      if (aiChatModes[chatId]) {
        delete aiChatModes[chatId];
      }
      
      try {
        // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∏—Ö —Ç–∞–ª–æ–Ω—ñ–≤ —É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
        const user = await User.findOne({ 
          where: { telegram_id: msg.from.id.toString() } 
        });
        
        if (!user) {
          throw new Error('–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');
        }
        
        const activeVouchers = await Voucher.findAll({
          where: { 
            owner_id: user.id,
            is_used: false,
            expiration_date: { [Op.gt]: new Date() }
          }
        });
        
        // –ë–∞–∑–æ–≤—ñ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é
        const keyboard = [
          ['üîç –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ —Ü—ñ–Ω', 'üõí –ü—Ä–∏–¥–±–∞—Ç–∏ —Ç–∞–ª–æ–Ω–∏'],
              ['üé´ –ú–æ—ó —Ç–∞–ª–æ–Ω–∏', 'ü§ñ AI –∞—Å–∏—Å—Ç–µ–Ω—Ç'],
              ['üìû –ü—ñ–¥—Ç—Ä–∏–º–∫–∞', 'üë§ –ú—ñ–π –ø—Ä–æ—Ñ—ñ–ª—å'],
              ['üìç –ó–Ω–∞–π—Ç–∏ –ê–ó–°'],
              ['ü§ù –°—Ç–∞—Ç–∏ –ø–∞—Ä—Ç–Ω–µ—Ä–æ–º']
        ];
        
        // –î–æ–¥–∞—î–º–æ –∫–Ω–æ–ø–∫—É "–ó–Ω–∞–π—Ç–∏ –ê–ó–°" —è–∫—â–æ —î –∞–∫—Ç–∏–≤–Ω—ñ —Ç–∞–ª–æ–Ω–∏
        if (activeVouchers.length > 0) {
          keyboard.splice(3, 0, ['üìç –ó–Ω–∞–π—Ç–∏ –ê–ó–°']);
        }
        
        // –ü–æ–∫–∞–∑—É—î–º–æ –≥–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é –∑ –º–æ–∂–ª–∏–≤–æ—é –¥–æ–¥–∞—Ç–∫–æ–≤–æ—é –∫–Ω–æ–ø–∫–æ—é
        await bot.sendMessage(chatId, 
          `–ì–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é:`, 
          {
            reply_markup: {
              keyboard: keyboard,
              resize_keyboard: true
            }
          }
        );
      } catch (error) {
        console.error('Error displaying main menu:', error);
        
        // –ü–æ–∫–∞–∑—É—î–º–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–µ –º–µ–Ω—é —É –≤–∏–ø–∞–¥–∫—É –ø–æ–º–∏–ª–∫–∏
        await bot.sendMessage(chatId, 
          `–ì–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é:`, 
          {
            reply_markup: {
              keyboard: [
                ['üîç –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ —Ü—ñ–Ω', 'üõí –ü—Ä–∏–¥–±–∞—Ç–∏ —Ç–∞–ª–æ–Ω–∏'],
              ['üé´ –ú–æ—ó —Ç–∞–ª–æ–Ω–∏', 'ü§ñ AI –∞—Å–∏—Å—Ç–µ–Ω—Ç'],
              ['üìû –ü—ñ–¥—Ç—Ä–∏–º–∫–∞', 'üë§ –ú—ñ–π –ø—Ä–æ—Ñ—ñ–ª—å'],
              ['üìç –ó–Ω–∞–π—Ç–∏ –ê–ó–°'],
              ['ü§ù –°—Ç–∞—Ç–∏ –ø–∞—Ä—Ç–Ω–µ—Ä–æ–º']
              ],
              resize_keyboard: true
            }
          }
        );
      }
    };
  }

  // –û–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ AI –∞—Å–∏—Å—Ç–µ–Ω—Ç–∞ –≤ –≥–æ–ª–æ–≤–Ω–æ–º—É –º–µ–Ω—é
  bot.onText(/ü§ñ AI –∞—Å–∏—Å—Ç–µ–Ω—Ç/, async (msg) => {
    const chatId = msg.chat.id;
    
    // –ê–∫—Ç–∏–≤—É—î–º–æ —Ä–µ–∂–∏–º –®–Ü –¥–ª—è —Ü—å–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
    aiChatModes[chatId] = true;
    
    await bot.sendMessage(
      chatId,
      `ü§ñ *–†–µ–∂–∏–º AI –∞—Å–∏—Å—Ç–µ–Ω—Ç–∞ –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ!*\n\n–¢–µ–ø–µ—Ä –≤–∏ –º–æ–∂–µ—Ç–µ –∑–∞–¥–∞–≤–∞—Ç–∏ –º–µ–Ω—ñ –±—É–¥—å-—è–∫—ñ –ø–∏—Ç–∞–Ω–Ω—è –ø—Ä–æ –ø–∞–ª—å–Ω–µ, –ê–ó–°, –∞–≤—Ç–æ–º–æ–±—ñ–ª—ñ —Ç–∞ —ó—Ö –æ–±—Å–ª—É–≥–æ–≤—É–≤–∞–Ω–Ω—è.\n\n–©–æ–± –≤–∏–π—Ç–∏ –∑ —Ä–µ–∂–∏–º—É AI –∞—Å–∏—Å—Ç–µ–Ω—Ç–∞, –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É "–í–∏–º–∫–Ω—É—Ç–∏ AI –∞—Å–∏—Å—Ç–µ–Ω—Ç–∞" –∞–±–æ –≤–≤–µ–¥—ñ—Ç—å /exit.`,
      {
        parse_mode: 'Markdown',
        reply_markup: {
          keyboard: [
            ['‚ùå –í–∏–º–∫–Ω—É—Ç–∏ AI –∞—Å–∏—Å—Ç–µ–Ω—Ç–∞'],
            ['üìù –ü—Ä–∏–∫–ª–∞–¥–∏ –ø–∏—Ç–∞–Ω—å'],
            ['üîô –ù–∞–∑–∞–¥ –¥–æ –º–µ–Ω—é']
          ],
          resize_keyboard: true
        }
      }
    );
  });
  
  // –û—Å–Ω–æ–≤–Ω–∏–π –æ–±—Ä–æ–±–Ω–∏–∫ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –¥–ª—è AI –∞—Å–∏—Å—Ç–µ–Ω—Ç–∞
  const originalMessageHandler = bot.on.bind(bot);
  bot.on = function(event, callback) {
    if (event === 'message') {
      return originalMessageHandler(event, async (msg) => {
        const chatId = msg.chat.id;
        
        // –Ø–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤ —Ä–µ–∂–∏–º—ñ –®–Ü —ñ —Ü–µ –Ω–µ –∫–æ–º–∞–Ω–¥–∞
        if (aiChatModes[chatId] && 
            msg.text && 
            !msg.text.startsWith('/') && 
            !msg.text.includes('–í–∏–º–∫–Ω—É—Ç–∏ AI –∞—Å–∏—Å—Ç–µ–Ω—Ç–∞') &&
            !msg.text.includes('–ü—Ä–∏–∫–ª–∞–¥–∏ –ø–∏—Ç–∞–Ω—å')) {
            
          try {
            // –ü–æ–∫–∞–∑—É—î–º–æ, —â–æ –±–æ—Ç –¥—Ä—É–∫—É—î
            await bot.sendChatAction(chatId, 'typing');
            
            // –û—Ç—Ä–∏–º—É—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –≤—ñ–¥ –®–Ü
            const aiResponse = await aiAssistant.processUkrainianQuery(msg.text);
            
            // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É
            await bot.sendMessage(chatId, aiResponse, {
              parse_mode: 'Markdown',
              reply_markup: {
                keyboard: [
                  ['‚ùå –í–∏–º–∫–Ω—É—Ç–∏ AI –∞—Å–∏—Å—Ç–µ–Ω—Ç–∞'],
                  ['üìù –ü—Ä–∏–∫–ª–∞–¥–∏ –ø–∏—Ç–∞–Ω—å'],
                  ['üîô –ù–∞–∑–∞–¥ –¥–æ –º–µ–Ω—é']
                ],
                resize_keyboard: true
              }
            });
            
            return; // –ù–µ –ø—Ä–æ–¥–æ–≤–∂—É—î–º–æ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è —ñ–Ω—à–∏—Ö –æ–±—Ä–æ–±–Ω–∏–∫—ñ–≤
          } catch (error) {
            console.error('AI assistant error:', error);
            
            // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –ø–æ–º–∏–ª–∫—É
            await bot.sendMessage(
              chatId,
              `–ù–∞ –∂–∞–ª—å, –≤–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ–±—Ä–æ–±—Ü—ñ –≤–∞—à–æ–≥–æ –∑–∞–ø–∏—Ç—É. –°–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ –∞–±–æ –∑–∞–¥–∞–π—Ç–µ —ñ–Ω—à–µ –ø–∏—Ç–∞–Ω–Ω—è.`,
              {
                reply_markup: {
                  keyboard: [
                    ['‚ùå –í–∏–º–∫–Ω—É—Ç–∏ AI –∞—Å–∏—Å—Ç–µ–Ω—Ç–∞'],
                    ['üìù –ü—Ä–∏–∫–ª–∞–¥–∏ –ø–∏—Ç–∞–Ω—å'],
                    ['üîô –ù–∞–∑–∞–¥ –¥–æ –º–µ–Ω—é']
                  ],
                  resize_keyboard: true
                }
              }
            );
            
            return;
          }
        }
        
        // –í–∏–∫–æ–Ω—É—î–º–æ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–π –æ–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è –≤—Å—ñ—Ö —ñ–Ω—à–∏—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
        callback(msg);
      });
    }
    
    return originalMessageHandler(event, callback);
  };
  
  return bot;
}

module.exports = { addAIAssistantHandlers };